{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - GeoSudoku{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
    .user-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding-top: 20px;
        position: relative;
    }
    
    /* Add floating animation background */
    .user-dashboard::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
            radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 20%),
            radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 20%),
            radial-gradient(circle at 40% 80%, rgba(255,255,255,0.1) 0%, transparent 20%);
        animation: float 6s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-20px); }
    }
    
    .container {
        position: relative;
        z-index: 1;
    }
    
    .dashboard-card {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        border: none;
        margin-bottom: 25px;
        backdrop-filter: blur(10px);
    }
    
    .dashboard-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
    }
    
    .level-progress-card {
        background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%);
        color: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 25px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
    }
    
    .level-progress-card::before {
        content: 'üéØ';
        position: absolute;
        top: -10px;
        right: -10px;
        font-size: 8rem;
        opacity: 0.1;
        z-index: 0;
    }
    
    .progress-bar-custom {
        height: 25px;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.3);
        overflow: hidden;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #FFD700 0%, #FFA500 50%, #FF6B6B 100%);
        border-radius: 15px;
        transition: width 0.8s ease;
        animation: shimmer 2s ease-in-out infinite;
    }
    
    @keyframes shimmer {
        0% { background-position: -200% center; }
        100% { background-position: 200% center; }
    }
    
    .stat-card {
        background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 50%, #FECFEF 100%);
        color: white;
        text-align: center;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card:hover {
        transform: translateY(-5px) rotate(2deg);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.25);
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
        transform: rotate(45deg);
        transition: transform 0.6s ease;
    }
    
    .stat-card:hover::before {
        transform: rotate(45deg) translate(20px, 20px);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 900;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .stat-label {
        font-size: 1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .game-card {
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .game-card:hover {
        transform: translateY(-10px) scale(1.05);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    }
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 15px;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: scale(1.05);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9rem;
        margin-top: 5px;
    }
    
    .puzzle-item {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        border-left: 4px solid #667eea;
    }
    
    .puzzle-item:hover {
        background: #f8f9fa;
        transform: translateX(5px);
    }
    
    .puzzle-completed {
        border-left-color: #28a745;
        background: #f8fff9;
    }
    
    .puzzle-attempted {
        border-left-color: #ffc107;
        background: #fffef8;
    }
    
    .quick-action-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 25px;
        padding: 15px 25px;
        color: white;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
        margin: 5px;
        text-align: center;
    }
    
    .quick-action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        color: white;
        text-decoration: none;
    }
    
    .achievement-badge {
        display: inline-block;
        background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
        color: #333;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        margin: 3px;
        font-weight: bold;
        box-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
    }
    
    .level-badge {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 5px 15px;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: bold;
        display: inline-block;
    }
    
    .performance-metric {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
    }
    
    .metric-label {
        color: #666;
        font-size: 0.9rem;
    }
    
    .game-item {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 3px solid #667eea;
    }
    
    .game-completed {
        border-left-color: #28a745;
    }
    
    .game-in-progress {
        border-left-color: #ffc107;
    }
    
    .welcome-header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
    }
    
    .welcome-header h1 {
        font-size: 2.5rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="user-dashboard">
    <div class="container">
        <!-- Welcome Header -->
        <div class="welcome-header">
            <h1><i class="bi bi-house-door"></i> Welcome back, {{ user.first_name|default:user.username }}!</h1>
            <p class="lead">Continue your puzzle journey and challenge your mind</p>
        </div>

        <!-- Current Level Progress -->
        {% if current_level %}
        <div class="level-progress-card">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h3><i class="bi bi-target"></i> Current Level: {{ current_level.level.name }}</h3>
                    <p class="mb-3">{{ current_level.level.description }}</p>
                    <div class="progress-bar-custom">
                        <div class="progress-bar-fill" style="width: {{ stats.current_level_progress }}%"></div>
                    </div>
                    <div class="mt-2">
                        <small>{{ current_level.puzzles_completed }} of {{ current_level.level.puzzles_required }} puzzles completed ({{ stats.current_level_progress }}%)</small>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="level-badge">
                        Level {{ current_level.level.level_number }}
                    </div>
                    <div class="mt-3">
                        {% if current_level.puzzles_completed < current_level.level.puzzles_required %}
                        <a href="{% url 'games:level_detail' current_level.level.id %}" class="btn btn-light btn-lg">
                            <i class="bi bi-play-fill"></i> Continue Playing
                        </a>
                        {% else %}
                        <span class="badge bg-success fs-6">Level Complete!</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Statistics Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number">{{ stats.completed_levels }}</div>
                    <div class="stat-label">Levels Completed</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number">{{ stats.total_games }}</div>
                    <div class="stat-label">Puzzles Played</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number">{{ stats.win_rate }}%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number">{{ stats.total_score }}</div>
                    <div class="stat-label">Total Score</div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Games Gallery -->
            <div class="col-md-8">
                <div class="dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-gamepad2"></i> üéÆ Play Games</h5>
                        <div class="row g-3">
                            <!-- Shape Puzzles Game Card -->
                            <div class="col-md-6">
                                <div class="game-card h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 20px; color: white; position: relative; overflow: hidden;">
                                    <div style="position: absolute; top: -20px; right: -20px; font-size: 4rem; opacity: 0.2;">üß©</div>
                                    <div class="d-flex flex-column h-100">
                                        <div class="mb-3">
                                            <h6 class="fw-bold text-white mb-2">Shape Puzzles</h6>
                                            <p class="small mb-0" style="color: rgba(255,255,255,0.9);">Challenge your spatial reasoning with our innovative shape placement puzzles</p>
                                        </div>
                                        <div class="mt-auto">
                                            <span class="badge bg-success mb-2">NEW</span>
                                            <br>
                                            <a href="{% url 'games:shape_game_list' %}" class="btn btn-light btn-sm fw-bold">
                                                <i class="bi bi-play-fill"></i> Play Now
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Number Puzzles Game Card -->
                            <div class="col-md-6">
                                <div class="game-card h-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 15px; padding: 20px; color: white; position: relative; overflow: hidden;">
                                    <div style="position: absolute; top: -20px; right: -20px; font-size: 4rem; opacity: 0.2;">üî¢</div>
                                    <div class="d-flex flex-column h-100">
                                        <div class="mb-3">
                                            <h6 class="fw-bold text-white mb-2">Number Puzzles</h6>
                                            <p class="small mb-0" style="color: rgba(255,255,255,0.9);">Classic Sudoku-style puzzles with geography themes</p>
                                        </div>
                                        <div class="mt-auto">
                                            <span class="badge bg-info mb-2">Classic</span>
                                            <br>
                                            <a href="{% url 'games:puzzle_list' %}" class="btn btn-light btn-sm fw-bold">
                                                <i class="bi bi-grid-3x3"></i> Play Now
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Level Progression Game Card -->
                            <div class="col-md-6">
                                <div class="game-card h-100" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 15px; padding: 20px; color: white; position: relative; overflow: hidden;">
                                    <div style="position: absolute; top: -20px; right: -20px; font-size: 4rem; opacity: 0.2;">üéØ</div>
                                    <div class="d-flex flex-column h-100">
                                        <div class="mb-3">
                                            <h6 class="fw-bold text-white mb-2">Level Progression</h6>
                                            <p class="small mb-0" style="color: rgba(255,255,255,0.9);">Progress through levels and unlock new challenges</p>
                                        </div>
                                        <div class="mt-auto">
                                            <span class="badge bg-warning mb-2">Adventure</span>
                                            <br>
                                            <a href="{% url 'games:level_list' %}" class="btn btn-light btn-sm fw-bold">
                                                <i class="bi bi-map"></i> Explore
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Admin Tools Card (only for admins) -->
                            {% if user.role == 'ADMIN' %}
                            <div class="col-md-6">
                                <div class="game-card h-100" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 15px; padding: 20px; color: white; position: relative; overflow: hidden;">
                                    <div style="position: absolute; top: -20px; right: -20px; font-size: 4rem; opacity: 0.2;">‚öôÔ∏è</div>
                                    <div class="d-flex flex-column h-100">
                                        <div class="mb-3">
                                            <h6 class="fw-bold text-white mb-2">Create Puzzles</h6>
                                            <p class="small mb-0" style="color: rgba(255,255,255,0.9);">Visual puzzle creator and admin tools</p>
                                        </div>
                                        <div class="mt-auto">
                                            <span class="badge bg-danger mb-2">Admin</span>
                                            <br>
                                            <a href="{% url 'games:visual_puzzle_creator' %}" class="btn btn-light btn-sm fw-bold">
                                                <i class="bi bi-magic"></i> Create
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4">
                <!-- Quick Actions -->
                <div class="dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-lightning-charge"></i> Quick Actions</h5>
                        <div class="d-grid gap-2">
                            {% for action in quick_actions %}
                            {% if action.url_params %}
                            <a href="{% url action.url action.url_params.level_id %}" class="quick-action-btn position-relative">
                                <i class="{{ action.icon }}"></i> {{ action.name }}
                                {% if action.badge %}
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-{{ action.badge_color|default:'primary' }}">
                                    {{ action.badge }}
                                </span>
                                {% endif %}
                            </a>
                            {% else %}
                            <a href="{% url action.url %}" class="quick-action-btn position-relative">
                                <i class="{{ action.icon }}"></i> {{ action.name }}
                                {% if action.badge %}
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-{{ action.badge_color|default:'primary' }}">
                                    {{ action.badge }}
                                </span>
                                {% endif %}
                            </a>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-graph-up"></i> Performance</h5>
                        <div class="performance-metric">
                            <div class="metric-value">{{ stats.best_score }}</div>
                            <div class="metric-label">Best Score</div>
                        </div>
                        {% if stats.avg_completion_time %}
                        <div class="performance-metric">
                            <div class="metric-value">{{ stats.avg_completion_time }}m</div>
                            <div class="metric-label">Average Time</div>
                        </div>
                        {% endif %}
                        <div class="performance-metric">
                            <div class="metric-value">{{ stats.total_levels_unlocked }}</div>
                            <div class="metric-label">Levels Unlocked</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Achievements -->
                {% if achievements %}
                <div class="dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-trophy"></i> Recent Achievements</h5>
                        {% for achievement in achievements %}
                        <div class="achievement-badge" title="Earned {{ achievement.earned_at|date:'M d, Y' }}">
                            <i class="bi bi-{{ achievement.achievement.icon }}"></i> {{ achievement.achievement.name }}
                        </div>
                        {% endfor %}
                        <div class="mt-3">
                            <a href="{% url 'games:user_achievements' %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-eye"></i> View All
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Level Progress Overview -->
                {% if unlocked_levels %}
                <div class="dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-layer-group"></i> Level Progress 
                            <span class="badge bg-success ms-2">NEW MAP</span>
                        </h5>
                        {% for progress in unlocked_levels %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <small><strong>Level {{ progress.level.level_number }}</strong></small>
                                <br>
                                <small class="text-muted">{{ progress.level.name }}</small>
                            </div>
                            <div class="text-end">
                                {% if progress.is_completed %}
                                <span class="badge bg-success">Complete</span>
                                {% else %}
                                <small class="text-muted">{{ progress.puzzles_completed }}/{{ progress.level.puzzles_required }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        <div class="mt-3">
                            <a href="{% url 'games:level_list' %}" class="btn btn-primary btn-sm position-relative w-100">
                                <i class="bi bi-map"></i> View Level Map
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                    NEW
                                </span>
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}